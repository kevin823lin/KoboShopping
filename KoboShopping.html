<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <script data-ad-client="ca-pub-1041865931422336" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.css">
        <title>Kobo Shopping</title>
    </head>
    <body>
        <h1>Kobo 單筆滿額贈點最佳化 Kobo Shopping Reward Optimization</h1>
        <div>可買可不買書價 Prices of optional books: <input type='text' id='optionals' size='60'></input>(用空白分隔 separated by spaces)</div>
        <div>想買書價 Prices of must-buy books: <input type='text' id='must-buys' size='60'></input>(用空白分隔 separated by spaces)</div>
        <div>獎勵門檻 Target bundle price: <input type='text' id='target' size='4' value='888'></input></div>
        <div><button id='go-btn'>計算</button></div>
        <div id='result'></div>
        <div>說明:
            <ol>
                <li>例如: 這次有三本書想買，價格分別為222元、333元、666元。則可在「可買可不買書價」中填入"222 333 666"。</li>
                <li>最近(2020年8月)Kobo獎勵活動通常是「滿888送323點」，故在「獎勵門檻」中填入"888"</li>
                <li>「多餘金額」是指購物車總額超過獎勵門檻的部分。例如，若某筆購物車共1000元，而獎勵門檻為888元，則多餘金額為 1000 - 888 = 112元。</li>
                <li>通常會有不只一種拆單方式，程式會選擇各購物車中多餘金額總和最少的方式</li>
                <li>通常會有一輛購物車的金額未達獎勵門檻。這輛購物車內的書可等到下次累積新的想買書名單後再來買。</li>
            </ol>
        </div>
    </body>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha256-4+XzXVhsDmqanXGHaHvgh1gMQKX40OUvDEBTu8JcmNs=" crossorigin="anonymous"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.21/jquery-ui.min.js" ></script>
    <link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.21/themes/sunny/jquery-ui.css" rel="stylesheet" type="text/css" >

    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.js"></script>

    <script>
        var solution_carts = [];
        var solution_rewards = -1;
        var solution_waste = Number.MAX_SAFE_INTEGER;
        var solution_mustbuy_left = 0;
        var carts = [];
        var books = [];
        
        $(document).ready(function() {
            var url = new URL(window.location);
            var mustbuys = url.searchParams.get("mustbuys");
            if (mustbuys != null) {
                $('#must-buys').val(mustbuys);
            }
            
            var optionals = url.searchParams.get("optionals");
            if (optionals != null) {
                $('#optionals').val(optionals);
            }

            var target = url.searchParams.get("target");
            if (target != null) {
                $('#target').val(target);
            }
            
            if ((mustbuys != null || optionals != null) && target != null) {
                _calc(mustbuys.split(' '), optionals.split(' '), target);
                $('#result-table').DataTable();
            }
            
            $( "#go-btn" ).click(function() {
                var mustbuys = $('#must-buys').val();
                var optionals = $('#optionals').val();
                var target = Number($('#target').val());
                var data = { mustbuys: mustbuys, optionals: optionals, target: target };
                window.location = '/KoboShopping.html?' + $.param(data);
                
                //_calc(mustbuys, optionals, target);
            });
        });
        function _calc(mustbuys, optionals, target) {
            books = [];
            var i;
            for (i = 0; i < mustbuys.length; i++) {
                var p = Number(mustbuys[i]);
                if (p > 0)
                    books.push({ mustbuy: true, price: p});
            }
            for (i = 0; i < optionals.length; i++) {
                var p = Number(optionals[i]);
                if (p > 0)
                    books.push({ mustbuy: false, price: p});
            }
            
            solution_waste = _sum(books);

            solution_carts = [];
            solution_rewards = -1;
            solution_waste = Number.MAX_SAFE_INTEGER;
            solution_mustbuy_left = 0;
            carts = [];
            _go(0, target);
            
            var html = "<div>購物車安排方式 Your solution (星號*為想買書價 * marks prices for must-buys)</div>";
            html += "<table id='result-table'><tr><th>購物車 Cart</th><th>書價組合 Combination of book prices</th><th>總價 Sum</th><th>多餘金額 Exceeds</th>";
            for (i = 0; i < solution_carts.length; i++) {
                var sum = _sum(solution_carts[i]);
                if (sum >= target) {
                    html += "<tr><td>" + (i + 1) + "</td><td>";
                    var j;
                    for (j = 0; j < solution_carts[i].length; j++) {
                        html += solution_carts[i][j].price;
                        if (solution_carts[i][j].mustbuy)
                            html += "*";
                        if (j < solution_carts[i].length - 1)
                            html += " + ";
                    }
                    html += "</td><td>" + sum + "</td><td>" + (sum - target) + "</td></tr>";
                }
            }

            for (i = 0; i < solution_carts.length; i++) {
                var sum = _sum(solution_carts[i]);
                if (sum < target) {
                    html += "<tr><td>可下次再買</td><td>";
                    var j;
                    for (j = 0; j < solution_carts[i].length; j++) {
                        html += solution_carts[i][j].price;
                        if (solution_carts[i][j].mustbuy)
                            html += "*";
                        if (j < solution_carts[i].length - 1)
                            html += " + ";
                    }
                    html += "</td><td>" + sum + "</td><td></td></tr>";
                }
            }

            $('#result').html(html);
        }
        
        function _go(i, target) {
            if (i == books.length) {
                var rewards = 0, waste = 0, mustbuy_left = 0, j = 0;
                for (j = 0; j < carts.length; j++) {
                    var sum = _sum(carts[j]);
                    if (sum >= target) {
                        rewards++;
                        waste += sum - target;
                    } else {
                        for (k = 0; k < carts[j].length; k++) {
                            if (carts[j][k].mustbuy) {
                                mustbuy_left++;
                            }
                        }
                    }
                }                
                
                if (rewards > solution_rewards || (rewards == solution_rewards && waste < solution_waste)) {
                    solution_carts = [];
                    $.extend(true, solution_carts, carts);
                    solution_rewards = rewards;
                    solution_waste = waste;
                    solution_mustbuy_left = mustbuy_left;
                }
            } else {
                var j;
                for (j = 0; j < carts.length; j++) {
                    var sum = _sum(carts[j]);
                    if (sum < target) {
                        carts[j].push(books[i]);
                        _go(i + 1, target);
                        carts[j].pop();
                    }
                }
                var newCart = [];
                newCart.push(books[i]);
                carts.push(newCart);
                _go(i + 1, target);
                carts.pop();
            }
        }
        function _sum(a) {
            var i;
            var s = 0;
            for (i = 0; i < a.length; i++) {
                s += a[i].price;
            }
            return s;
        }
    </script>
</html>
